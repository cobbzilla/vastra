<html>
<head>
    <title>Nerva</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!--<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />-->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
          integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin=""/>
    <link rel="stylesheet" type="text/css" href="nerva.css">

    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
            integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
            crossorigin=""></script>
    <script src="jquery-3.3.1.min.js"></script>
</head>
<body>

<div id="map" style="width: 600px; height: 400px;"></div>

<button onclick="generateCSV()">generate CSV</button>
<div id="csvDiv">
</div>

<div>
    <table border="1" cellspacing="2" cellpadding="2">
        <thead>
            <tr><th>Time</th><th>Lat</th><th>Lon</th><th>Acc</th><th>Alt</th><th>AltAcc</th></tr>
        </thead>
        <tbody id="gpsdata"></tbody>
    </table>
</div>

<button onclick="resetAll()">Clear ALL Data</button>

<script>

    var watch;
    var map = L.map('map').fitWorld();
    var MB_TOKEN_KEY = 'MAPBOX_TOKEN';
    var MAPBOX_TOKEN = null;
    var gpsData = [];

    function showPosition(position) {
        var datum = {
          time: Date.now(),
          lat: position.coords.latitude,
          lon: position.coords.longitude,
          accuracy: position.coords.accuracy,
          altitude: position.coords.altitude,
          altitudeAccuracy: position.coords.altitudeAccuracy
        };
        var row = $('<tr></tr>');
        row.append($('<td>Time '+Date.now()+'</td>'));
        row.append($('<td>Lat '+datum.lat+'</td>'));
        row.append($('<td>Lon '+datum.lon+'</td>'));
        row.append($('<td>Acc '+datum.accuracy+'</td>'));
        row.append($('<td>Alt '+datum.altitude+'</td>'));
        row.append($('<td>AltAcc '+datum.altitudeAccuracy+'</td>'));
        $('#gpsdata').prepend(row);
        map.setView([datum.lat, datum.lon], 20);
        L.circle([datum.lat, datum.lon], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 5
        }).addTo(map);
        gpsData.push(datum);
    }

    function generateCSV () {
        var csvData = "Time,Lat,Lon,Accuracy,Alt,AltAccuracy\r\n";
        for (var i=0; i < gpsData.length; i++) {
            var datum = gpsData[i];
            csvData = csvData + datum.time + "," + datum.lat+","+datum.lon+","+datum.accuracy+","+datum.altitude+","+datum.altitudeAccuracy+"\r\n";
        }
        var now = Date.now();
        $('#csvDiv').html('<a download="nerva_gps_'+now+'.csv" href="data:text/csv;charset=utf-8,'+encodeURIComponent(csvData)+'">download CSV</a>');
    }

    function resetAll () {
        localStorage.clear();
        location.reload();
    }

    $(function () {
        if (MAPBOX_TOKEN == null) {
            MAPBOX_TOKEN = localStorage.getItem(MB_TOKEN_KEY);
            if (typeof MAPBOX_TOKEN === "undefined" || MAPBOX_TOKEN == null) {
                MAPBOX_TOKEN = window.prompt('API key for MapBox');
                localStorage.setItem(MB_TOKEN_KEY, MAPBOX_TOKEN)
            }
        }

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token='+MAPBOX_TOKEN, {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.streets'
        }).addTo(map);

        if (navigator.geolocation) {
            watch = navigator.geolocation.watchPosition(showPosition);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    });

</script>

</body>
</html>
